/**
 * All icons from http://www.flaticon.com is licensed by http://creativecommons.org/licenses/by/3.0/
 * plane icon made by http://www.flaticon.com/authors/dave-gandy
 * find icon made by http://www.freepik.com
 * marker icon made by http://www.freepik.com
 * center icon made by http://www.freepik.com 
 * gear icon made by http://www.flaticon.com/authors/egor-rumyantsev
 */
var dmgig_icons = {
  plane : "data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCIgdmlld0JveD0iMCAwIDQwMC4xNTYgNDAwLjE1NSIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDAwLjE1NiA0MDAuMTU1OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxnPgoJPHBhdGggZD0iTTM5Ni4zMSw0OS41NDVjNi4wODgtMTguMjcxLDQuOTQ5LTMyLjM1NC0zLjQzMi00Mi4yNTVjLTkuODk3LTguMzc2LTIzLjk4My05LjUxNC00Mi4yNTgtMy40MzQgICBjLTE4LjI3Myw2LjA5MS0zNC42NDMsMTYuMzY4LTQ5LjExMSwzMC44MzNsLTQ1LjY3OSw0NS42ODNMNjUuOTczLDM0Ljk3OGMtMy4wNDYtMC45NTMtNS45MDEtMC4xOTItOC41NjQsMi4yODJMMjAuODYyLDczLjgwNSAgIGMtMi4wOTEsMi4wOTYtMi45NSw0LjY2NS0yLjU2OCw3LjcxYzAuNTcxLDMuMDQ5LDIuMTksNS4zMyw0Ljg1NCw2Ljg1NGwxNDUuMDM4LDc5LjY1NmwtNzMuOTQ4LDczLjk0OEwzOC44NSwyMjYuODQ1ICAgYy0wLjM4LTAuMTkyLTEuMTM5LTAuMjg4LTIuMjgyLTAuMjg4Yy0yLjY2NiwwLTQuODUzLDAuODU1LTYuNTY3LDIuNTdMMi41OTQsMjU2LjgxOWMtMS45MDMsMi4yNzktMi43NTgsNC42Ni0yLjU2OCw3LjEzMiAgIGMwLjM3OCwzLjA0NSwxLjYxNSw1LjIzNSwzLjcxMSw2LjU3bDcxLjk0Niw1My45NTdsNTMuOTU5LDcxLjk0NGMxLjcxNCwyLjA5OCwzLjk5OSwzLjMyOSw2Ljg1NCwzLjcxNmgwLjU3MSAgIGMyLjY2NiwwLDQuODUzLTAuODU1LDYuNTY3LTIuNTY2bDI3LjQwNi0yNy40MDRjMi40NzQtMi42NjksMy4yMzYtNS42MTksMi4yODYtOC44NTRsLTE1LjEzMy01NS4zODhsNzMuOTQ3LTczLjk1M0wzMTEuOCwzNzcuMDE5ICAgYzEuMTQsMi40NzUsMy4xMzgsMy45OTcsNS45OTUsNC41NjljMC41NjgsMC4xOTEsMS4yMzUsMC4yODQsMS45OTksMC4yODRjMi4yNzksMCw0LjA5LTAuNTcyLDUuNDIxLTEuNzEybDM2LjU1Mi0yNy40MDcgICBjMy4yMy0yLjY2Myw0LjM3My01LjgwMSwzLjQyNi05LjQxOGwtNDUuNjgtMTk4LjcxMWw0NS45NjctNDUuOTY1QzM3OS45NDIsODQuMTg4LDM5MC4yMTksNjcuODE2LDM5Ni4zMSw0OS41NDV6IiBmaWxsPSIjMDAwMDAwIi8+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPC9zdmc+Cg==",
  find  : "data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCIgdmlld0JveD0iMCAwIDQ1LjAwOCA0NS4wMDkiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDQ1LjAwOCA0NS4wMDk7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+Cgk8cGF0aCBkPSJNNDMuNDYyLDM1Ljk5N2wtMTEuNDAxLTExLjM3YzEuMTk3LTIuMzUyLDEuODQ1LTQuOTYyLDEuODQ1LTcuNjc2YzAtNC41MjgtMS43NjUtOC43ODUtNC45NjYtMTEuOTg2ICAgQzI1LjczOSwxLjc2MywyMS40ODEsMCwxNi45NTMsMEMxMi40MjYsMCw4LjE2NywxLjc2Myw0Ljk2Niw0Ljk2NUMxLjc2NSw4LjE2NywwLDEyLjQyNCwwLDE2Ljk1MiAgIGMwLDQuNTI4LDEuNzY0LDguNzg1LDQuOTY2LDExLjk4NmMzLjIwMSwzLjIwMiw3LjQ1OSw0Ljk2NSwxMS45ODYsNC45NjVjMi43MTQsMCw1LjMyNS0wLjY0Niw3LjY3NS0xLjg0MmwxMS4zNzEsMTEuNDAyICAgYzEuMDI5LDEuMDI5LDIuMzgyLDEuNTQ2LDMuNzMyLDEuNTQ2YzEuMzUsMCwyLjcwMS0wLjUxNywzLjczMS0xLjU0NkM0NS41MjQsNDEuNCw0NS41MjQsMzguMDU5LDQzLjQ2MiwzNS45OTd6IE05LjQ0NCwyNC40NTkgICBjLTIuMDA1LTIuMDA2LTMuMTA5LTQuNjcxLTMuMTA5LTcuNTA3czEuMTA0LTUuNTAyLDMuMTEtNy41MDhjMi4wMDUtMi4wMDUsNC42NzEtMy4xMSw3LjUwNy0zLjExczUuNTAyLDEuMTA0LDcuNTA4LDMuMTEgICBjMi4wMDUsMi4wMDUsMy4xMSw0LjY3MSwzLjExLDcuNTA3cy0xLjEwNSw1LjUwMi0zLjExLDcuNTA4Yy0yLjAwNiwyLjAwNS00LjY3MywzLjEwOS03LjUwOCwzLjEwOSAgIEMxNC4xMTcsMjcuNTY4LDExLjQ1MSwyNi40NjUsOS40NDQsMjQuNDU5eiIgZmlsbD0iIzAwMDAwMCIvPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",
  marker: "data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCIgdmlld0JveD0iMCAwIDQ1LjM1NCA0NS4zNTQiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDQ1LjM1NCA0NS4zNTQ7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNMjIuNjc3LDBDMTIuNTA5LDAsNC4yNjYsOC4yNDMsNC4yNjYsMTguNDExYzAsOS4yMjQsMTEuNDcxLDIxLjM2LDE2LjMwNSwyNi4wNjVjMS4xODQsMS4xNSwzLjA1NiwxLjE3NCw0LjI2MywwLjA0NyAgICBjNC44NjMtNC41MzMsMTYuMjU0LTE2LjIxMSwxNi4yNTQtMjYuMTEzQzQxLjA4Nyw4LjI0MywzMi44NDUsMCwyMi42NzcsMHogTTIyLjY3NywyNC4zOTNjLTQuMjA0LDAtNy42MS0zLjQwNi03LjYxLTcuNjA5ICAgIHMzLjQwNi03LjYxLDcuNjEtNy42MWM0LjIwMywwLDcuNjA4LDMuNDA2LDcuNjA4LDcuNjFTMjYuODgsMjQuMzkzLDIyLjY3NywyNC4zOTN6IiBmaWxsPSIjMDAwMDAwIi8+Cgk8L2c+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPC9zdmc+Cg==",
  center: "data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0LjIgMjQuMiIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQuMiAyNC4yIiB3aWR0aD0iMTZweCIgaGVpZ2h0PSIxNnB4Ij4KICA8Zz4KICAgIDxwYXRoIGQ9Im0yNC4xLDE1LjF2MmMwLDAuNi0wLjQsMS0xLDFoLTFjLTAuNCwwLTAuNywwLjUtMC40LDAuOWwyLDJjMC40LDAuNCAwLjQsMSAwLDEuNGwtMS40LDEuNGMtMC40LDAuNC0xLDAuNC0xLjQsMGwtMi0yYy0wLjMtMC4zLTAuOS0wLjEtMC45LDAuNHYxYzAsMC42LTAuNCwxLTEsMWgtMmMtMC42LDAtMS0wLjQtMS0xdi04YzAtMC42IDAuNC0xIDEtMWg4YzAuNy0wLjEgMS4xLDAuMyAxLjEsMC45eiIgZmlsbD0iIzAwMDAwMCIvPgogICAgPHBhdGggZD0iTTMuMiwwLjRsMiwyQzUuNSwyLjcsNi4xLDIuNSw2LjEsMlYxYzAtMC42LDAuNC0xLDEtMWgyYzAuNiwwLDEsMC40LDEsMXY4YzAsMC42LTAuNCwxLTEsMWgtOGMtMC42LDAtMS0wLjQtMS0xVjcgICBjMC0wLjYsMC40LTEsMS0xaDFjMC40LDAsMC43LTAuNSwwLjQtMC45bC0yLTJjLTAuNC0wLjQtMC40LTEsMC0xLjRsMS40LTEuNEMyLjIsMCwyLjgsMCwzLjIsMC40eiIgZmlsbD0iIzAwMDAwMCIvPgogICAgPGc+CiAgICAgIDxwYXRoIGQ9Im0yNC4xLDkuMXYtMmMwLTAuNi0wLjQtMS0xLTFoLTFjLTAuNCwwLTAuNy0wLjUtMC40LTAuOWwyLTJjMC40LTAuNCAwLjQtMSAwLTEuNGwtMS40LTEuNGMtMC40LTAuNC0xLTAuNC0xLjQsMGwtMiwyYy0wLjMsMC4zLTAuOSwwLjEtMC45LTAuNHYtMWMwLTAuNi0wLjQtMS0xLTFoLTJjLTAuNiwwLTEsMC40LTEsMXY4YzAsMC42IDAuNCwxIDEsMWg4YzAuNywwLjEgMS4xLTAuMyAxLjEtMC45eiIgZmlsbD0iIzAwMDAwMCIvPgogICAgICA8cGF0aCBkPSJtMy4yLDIzLjhsMi0yYzAuMy0wLjMgMC45LTAuMSAwLjksMC40djFjMCwwLjYgMC40LDEgMSwxaDJjMC42LDAgMS0wLjQgMS0xdi04YzAtMC42LTAuNC0xLTEtMWgtOGMtMC42LDAtMSwwLjQtMSwxdjJjMCwwLjYgMC40LDEgMSwxaDFjMC40LDAgMC43LDAuNSAwLjQsMC45bC0yLDJjLTAuNCwwLjQtMC40LDEgMCwxLjRsMS40LDEuNGMwLjMsMC4zIDAuOSwwLjMgMS4zLTAuMXoiIGZpbGw9IiMwMDAwMDAiLz4KICAgIDwvZz4KICA8L2c+Cjwvc3ZnPgo=",
  gear  : "data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMS4xLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDI2OC43NjUgMjY4Ljc2NSIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMjY4Ljc2NSAyNjguNzY1OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCI+CjxnIGlkPSJTZXR0aW5ncyI+Cgk8Zz4KCQk8cGF0aCBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7IiBkPSJNMjY3LjkyLDExOS40NjFjLTAuNDI1LTMuNzc4LTQuODMtNi42MTctOC42MzktNi42MTcgICAgYy0xMi4zMTUsMC0yMy4yNDMtNy4yMzEtMjcuODI2LTE4LjQxNGMtNC42ODItMTEuNDU0LTEuNjYzLTI0LjgxMiw3LjUxNS0zMy4yMzFjMi44ODktMi42NDEsMy4yNC03LjA2MiwwLjgxNy0xMC4xMzMgICAgYy02LjMwMy04LjAwNC0xMy40NjctMTUuMjM0LTIxLjI4OS0yMS41Yy0zLjA2My0yLjQ1OC03LjU1Ny0yLjExNi0xMC4yMTMsMC44MjVjLTguMDEsOC44NzEtMjIuMzk4LDEyLjE2OC0zMy41MTYsNy41MjkgICAgYy0xMS41Ny00Ljg2Ny0xOC44NjYtMTYuNTkxLTE4LjE1Mi0yOS4xNzZjMC4yMzUtMy45NTMtMi42NTQtNy4zOS02LjU5NS03Ljg0OWMtMTAuMDM4LTEuMTYxLTIwLjE2NC0xLjE5Ny0zMC4yMzItMC4wOCAgICBjLTMuODk2LDAuNDMtNi43ODUsMy43ODYtNi42NTQsNy42ODljMC40MzgsMTIuNDYxLTYuOTQ2LDIzLjk4LTE4LjQwMSwyOC42NzJjLTEwLjk4NSw0LjQ4Ny0yNS4yNzIsMS4yMTgtMzMuMjY2LTcuNTc0ICAgIGMtMi42NDItMi44OTYtNy4wNjMtMy4yNTItMTAuMTQxLTAuODUzYy04LjA1NCw2LjMxOS0xNS4zNzksMTMuNTU1LTIxLjc0LDIxLjQ5M2MtMi40ODEsMy4wODYtMi4xMTYsNy41NTksMC44MDIsMTAuMjE0ICAgIGM5LjM1Myw4LjQ3LDEyLjM3MywyMS45NDQsNy41MTQsMzMuNTNjLTQuNjM5LDExLjA0Ni0xNi4xMDksMTguMTY1LTI5LjI0LDE4LjE2NWMtNC4yNjEtMC4xMzctNy4yOTYsMi43MjMtNy43NjIsNi41OTcgICAgYy0xLjE4MiwxMC4wOTYtMS4xOTYsMjAuMzgzLTAuMDU4LDMwLjU2MWMwLjQyMiwzLjc5NCw0Ljk2MSw2LjYwOCw4LjgxMiw2LjYwOGMxMS43MDItMC4yOTksMjIuOTM3LDYuOTQ2LDI3LjY1LDE4LjQxNSAgICBjNC42OTgsMTEuNDU0LDEuNjc4LDI0LjgwNC03LjUxNCwzMy4yM2MtMi44NzUsMi42NDEtMy4yNCw3LjA1NS0wLjgxNywxMC4xMjZjNi4yNDQsNy45NTMsMTMuNDA5LDE1LjE5LDIxLjI1OSwyMS41MDggICAgYzMuMDc5LDIuNDgxLDcuNTU5LDIuMTMxLDEwLjIyOC0wLjgxYzguMDQtOC44OTMsMjIuNDI3LTEyLjE4NCwzMy41MDEtNy41MzZjMTEuNTk5LDQuODUyLDE4Ljg5NSwxNi41NzUsMTguMTgxLDI5LjE2NyAgICBjLTAuMjMzLDMuOTU1LDIuNjcsNy4zOTgsNi41OTUsNy44NWM1LjEzNSwwLjU5OSwxMC4zMDEsMC44OTgsMTUuNDgxLDAuODk4YzQuOTE3LDAsOS44MzUtMC4yNywxNC43NTItMC44MTcgICAgYzMuODk3LTAuNDMsNi43ODQtMy43ODYsNi42NTMtNy42OTZjLTAuNDUxLTEyLjQ1NCw2Ljk0Ni0yMy45NzMsMTguMzg2LTI4LjY1N2MxMS4wNTktNC41MTcsMjUuMjg2LTEuMjExLDMzLjI4MSw3LjU3MiAgICBjMi42NTcsMi44OSw3LjA0NywzLjIzOSwxMC4xNDIsMC44NDhjOC4wMzktNi4zMDQsMTUuMzQ5LTEzLjUzNCwyMS43NC0yMS40OTRjMi40OC0zLjA3OSwyLjEzLTcuNTU5LTAuODAzLTEwLjIxMyAgICBjLTkuMzUzLTguNDctMTIuMzg4LTIxLjk0Ni03LjUyOS0zMy41MjRjNC41NjgtMTAuODk5LDE1LjYxMi0xOC4yMTcsMjcuNDkxLTE4LjIxN2wxLjY2MiwwLjA0MyAgICBjMy44NTMsMC4zMTMsNy4zOTgtMi42NTUsNy44NjUtNi41ODhDMjY5LjA0NCwxMzkuOTE3LDI2OS4wNTgsMTI5LjYzOSwyNjcuOTIsMTE5LjQ2MXogTTEzNC41OTUsMTc5LjQ5MSAgICBjLTI0LjcxOCwwLTQ0LjgyNC0yMC4xMDYtNDQuODI0LTQ0LjgyNGMwLTI0LjcxNywyMC4xMDYtNDQuODI0LDQ0LjgyNC00NC44MjRjMjQuNzE3LDAsNDQuODIzLDIwLjEwNyw0NC44MjMsNDQuODI0ICAgIEMxNzkuNDE4LDE1OS4zODUsMTU5LjMxMiwxNzkuNDkxLDEzNC41OTUsMTc5LjQ5MXoiIGZpbGw9IiMwMDAwMDAiLz4KCTwvZz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K"
}

/**
 * geoInput
 * 
 * add location details to html forms. lat, lng, text. 
 *
 * requires google maps v3 api code. 
 *
 * @author   Dave M. Giglio <dave.m.giglio@gmail.com>
 */

/*
The MIT License (MIT)

  Copyright (c) 2015 Dave M. Giglio <dave.m.giglio@gmail.com>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

/*global google: true, jQuery: true */
/*jslint browser: true, todo: true, devel: true */
/*properties
  LatLng, Map, Marker, addListener, address_components, after, apikey, append,
  appendTo, attr, 'background-color', bgColor, bgColorMap, bgcolor, border,
  'border-radius', center, centerOnMarker, centerStore, centerToMarker, clear,
  clearPreferences, click, closest, color, css, cursor, data, display, empty,
  event, extend, fail, float, fn, 'font-family', 'font-size', geoCode,
  geoCodeInput, geoControls, geoInput, geocodeTextLocation, geometry, get,
  getCenter, getElementById, getInputId, getItem, getPosition,
  getStoredMapCenter, getStoredZoom, getZoom, height, hiddenInputs, hide,
  hover, html, i_centerOnMarker, i_geoCode, i_markerToCenter, i_revGeoCode,
  i_togglePrefs, id, initialize, join, lat, latInput, latLngDisplay,
  latLngGoogleToString, latLngStringToGoogle, left, length, lng, lngInput,
  location, log, long_name, map, mapCenter, mapControls, mapOptions, maps,
  margin, 'margin-bottom', marker, markerToCenter, 'min-width', name, on,
  padding, parent_form, position, precision, prefs, prefsPanel, prepend, prop,
  rGeoResults, removeItem, results, revGeoCode, revGeoCodeFoundCount,
  revGeoCodeResultsBody, revGeoCodeResultsHide,
  revGeocodeResultsAddHiddenInputs, revGeocodeResultsMakeRow,
  reverseGeocodeMarkerPosition, rgcHead, rgcTable, rgcTh1, rgcTh2, rgcTr,
  setCenter, setDraggable, setItem, setLatLngInputs, setMap, setPosition,
  short_name, show, slideToggle, spacerLeft, spacerRight, split,
  storeMapCenter, storeMarkerCount, storeZoomLevel, 'text-align', title,
  toFixed, toString, togglePrefs, txtColor, type, types, val,
  validateUniqueElementId, value, watchMarkerMove, width, 'z-index', zoom,
  zoomLevel, zoomStore
*/



(function ($, google, icons) {

  'use strict';

  $.fn.geoInput = function (options) {

    var 
      GI  = this, 
      $GI = $(this),
      $GIid = $GI.attr('id'),
      Helper, 
      Prefs,
      Layout,
      settings;

    GI.map    = null;
    GI.mapOptions = {};
    GI.marker   = new google.maps.Marker();

    /** 
     * HELPERS
     */
    Helper = {
      /**
       * latLng string to to google obj. '0,0'
       */
      latLngStringToGoogle : function (latLngString) {
        var center = latLngString.split(',');
        return new google.maps.LatLng(center[0], center[1]);
      },

      latLngGoogleToString : function (latLngGoogle) {
        return latLngGoogle.lat().toFixed(settings.precision) + ',' + latLngGoogle.lng().toFixed(settings.precision);
      },

      validateUniqueElementId : function (el) {
        return $('#'+$GIid).length === 1 ? true : false;
      }
    };

    /** 
     * SETTINGS
     */
    settings = $.extend({
      apikey       : "<APIKEY>",
      width        : "300px",
      height       : "150px",
      bgColorMap   : "#A3C3FF",
      bgColor      : '#DDD',
      txtColor     : '#000',
      precision    : 6,
      zoomLevel    : 2,
      mapCenter    : '0,0'
    }, options);


    /**
     * PREFERENCES
     */
    Prefs = function(){

      var 
        zoomStoreKey   = 'dmgig_' + $GIid + '_zoomLevel',
        centerStoreKey = 'dmgig_' + $GIid + '_mapCenter';
      
      return {

        storeZoomLevel : function (zoom) {
          sessionStorage.setItem(zoomStoreKey, zoom);
          console.log(sessionStorage);
        },

        storeMapCenter : function (center) {
          sessionStorage.setItem(centerStoreKey, Helper.latLngGoogleToString(center));
          console.log(sessionStorage);
        },

        getStoredZoom : function () {
          var zoom = sessionStorage.getItem(zoomStoreKey);
          if(zoom !== null) zoom = parseInt(zoom);
          console.log(zoom);
          return zoom;
        },

        getStoredMapCenter : function () {
          var center = sessionStorage.getItem(centerStoreKey);
          if(center != null) center = Helper.latLngStringToGoogle(center);
          console.log(center);
          return center;
        },
        
        clearPreferences : function () {
          sessionStorage.removeItem(zoomStoreKey);
          sessionStorage.removeItem(centerStoreKey);
          console.log(sessionStorage);
        }
      }
    }();

    // set prefs options
    settings.mapCenter = Helper.latLngStringToGoogle(settings.mapCenter);
    if (Prefs.getStoredZoom()     ) { settings.zoomLevel = Prefs.getStoredZoom();      }
    if (Prefs.getStoredMapCenter()) { settings.mapCenter = Prefs.getStoredMapCenter(); }

    // wipe
    $GI.empty();

    var Layout = function(){    
      /**
       * layout html */
      var t = {};
      // main template
      t.geoInput     = $('<div/>', { id : 'dmgig_geoInput_' + $GIid });
      t.map          = $('  <div/>', { id : 'dmgig_map_' + $GIid }).appendTo(t.geoInput);
      t.mapControls  = $('  <div/>').appendTo(t.geoInput);
      t.geoControls  = $('  <div/>').appendTo(t.geoInput);
      t.clear        = $('    <div style="clear:both"></div>').appendTo(t.geoControls);
      t.rGeoResults  = $('  <div/>').appendTo(t.geoInput);
      t.rgcTable     = $('    <table>').appendTo(t.rGeoResults);
      t.rgcHead      = $('      <thead>').appendTo(t.rgcTable);
      t.rgcTr        = $('        <tr>').appendTo(t.rgcHead);
      t.rgcTh1       = $('          <th>&nbsp;&nbsp;&nbsp;Result Sets Found:</th>').appendTo(t.rgcTr);
      t.rgcTh2       = $('          <th></th>').appendTo(t.rgcTr);
      $GI.append(t.geoInput); // append main template

      /**
       * CREATE interactive and other elements */
      // display
      t.latLngDisplay     = $('<div/>');
      t.revGeoCodeResultsBody = $('<tbody>');
      t.revGeoCodeFoundCount  = $('<span/>');
      t.prefsPanel      = $('<div/>');
      // buttons
      t.geoCode         = $('<div/>', { title : 'geocode from text' });
      t.revGeoCode      = $('<div/>', { title : 'reverse geocode marker location' });
      t.markerToCenter    = $('<div/>', { title : 'bring marker(s) to center' });
      t.centerOnMarker    = $('<div/>', { title : 'center map on marker(s)' });
      t.revGeoCodeResultsHide = $('<span/>', { title : 'hide results' });
      // prefs buttons
      t.togglePrefs       = $('<div/>', { title : 'toggle preferences' });
      t.storeZoomLevel    = $('<div/>', { title : 'store zoom level' });
      t.storeMapCenter    = $('<div/>', { title : 'store map center' });
      t.storeMarkerCount    = $('<div/>', { title : 'store marker count' });
      t.clearPreferences    = $('<div/>', { title : 'clear data storage' });
      // inputs, and input containers
      t.geoCodeInput      = $('<input/>');
      t.latInput        = $('<input/>', { type : 'hidden', name : 'lat' });
      t.lngInput        = $('<input/>', { type : 'hidden', name : 'lng' });
      t.hiddenInputs      = $('<div/>'); // div to contain hidden inputs from geocoding results
      // other elements
      t.spacerRight       = $('<div/>'); // layout spacers
      t.spacerLeft      = $('<div/>');

      /**
       * ATTACH interactive elements */
      t.mapControls.append(t.latLngDisplay);

      if (settings.apikey !== "<APIKEY>" && settings.apikey !== '') {
        t.geoControls.prepend(t.geoCode,
                    t.geoCodeInput,
                    t.spacerLeft,
                    t.revGeoCode,
                    t.togglePrefs,
                    t.spacerRight,
                    t.markerToCenter,
                    t.centerOnMarker);
      } else {
        t.geoControls.prepend(t.geoCode,
                    t.geoCodeInput,
                    t.spacerLeft,
                    t.togglePrefs,
                    t.spacerRight,
                    t.markerToCenter,
                    t.centerOnMarker);
      }

      t.rgcTh1.prepend(t.revGeoCodeResultsHide);
      t.rgcTh1.append(t.revGeoCodeFoundCount);

      t.rgcTable.append(t.revGeoCodeResultsBody);

      t.rGeoResults.after(t.latInput,
                t.lngInput,
                t.hiddenInputs);

      t.prefsPanel.append(t.storeZoomLevel,
                t.storeMapCenter,
                t.clearPreferences); // todo: t.storeMarkerCount

      t.geoControls.after(t.prefsPanel);

      /**
       * CSS */
      function button(selector, content, float) {
        selector.css({
          'width'       : "16px",
          'height'      : "16px",
          'padding'       : "3px 2px",
          'float'       : float,
          'color'       : settings.color,
          'background-color'  : settings.bgcolor,
          'text-align'    : 'center',
          'cursor'      : 'pointer'
        });
        content = $("<img />")
              .attr("src", content)
              .css({ width: "16px", height: "16px" });
        selector.html(content);
        return selector;
      }

      function prefsButton(selector, content) {
        selector.css({
          'height'      : '16px',
          'padding'       : '1px',
          'margin'      : '1px',
          'color'       : settings.color,
          'background-color'  : settings.bgcolor,
          'font-size'     : '12px',
          'font-family'     : 'console',
          'cursor'      : 'pointer'
        });
        selector.html(content);
        selector.hover(function () {
          selector.css({
            'color' : settings.bgcolor,
            'background-color' : settings.color
          });
        }, function () {
          selector.css({
            'color' : settings.color,
            'background-color' : settings.bgColor
          });
        });
        return selector;
      }

      function spacer(selector, float) {
        selector.css({
          'width'   : '16px',
          'height'  : '16px',
          'padding' : '1px',
          'margin'  : '1px',
          'float'   : float
        });
        return selector;
      }

      t.geoInput.css({
        'font-family': 'Arial',
        'width'    : settings.width,
        'position'   : 'relative',
        'border'   : '1px solid #AAA'
      });

      t.map.css({
        'width'      : settings.width,
        'height'       : settings.height,
        'border'       : '1px solid #CCC',
        'background-color' : settings.bgColor,
        'text-align'     : 'center'
      });
      t.map.html('<br /><br />loading...');

      t.rGeoResults.css({
        'clear'      : 'both',
        'display'      : 'none',
        'left'       : '-1px',
        'width'      : 'calc(' + settings.width + ' - 8px)',
        'background-color' : '#FFF',
        'border'       : '2px solid #CCC',
        'position'     : 'absolute',
        'z-index'      : '5555',
        'text-align'     : 'left',
        'padding'      : '3px'
      });

      t.rgcTable.css({
        'font-size'    : '12px',
        'font-family'    : 'Arial'
      });

      t.prefsPanel
      .append($("<img />").attr("src", icons.gear))
      .css({
        'clear'       : 'both',
        'display'       : 'none',
        'left'        : '-1px',
        'width'       : 'calc(' + settings.width + ' - 2px)',
        'background-color'  : '#DDD',
        'border'      : '2px solid #CCC',
        'position'      : 'absolute',
        'z-index'       : '9999'
      });

      t.latLngDisplay.css({
        'font-family'    : 'monospace',
        'font-size'    : '12px',
        'text-align'     : 'center',
        'background-color' : '#333',
        'color'      : '#FFF',
        'margin-bottom'  : '2px'
      });
      t.latLngDisplay.html('0,0');

      button(t.geoCode,    icons.plane,  'left');
      button(t.revGeoCode,   icons.find,   'left');
      button(t.markerToCenter, icons.center, 'right');
      button(t.centerOnMarker, icons.marker, 'right');
      button(t.togglePrefs,  icons.gear,   'right');

      t.revGeoCodeResultsHide.html('&times;').css('cursor', 'pointer');

      prefsButton(t.storeZoomLevel, 'store zoom level');
      prefsButton(t.storeMapCenter, 'store map center position');
      prefsButton(t.storeMarkerCount, 'store markers count');
      prefsButton(t.clearPreferences, 'clear storage data');

      t.geoCodeInput.css({ 'float' : 'left' });

      // other elements
      spacer(t.spacerRight, 'right');
      spacer(t.spacerLeft, 'left');

      /**
       * attach events
       */
      t.geoCode.on('click', function () {
        GI.geocodeTextLocation();
      });

      t.revGeoCode.on('click', function () {
        GI.reverseGeocodeMarkerPosition();
      });

      t.centerOnMarker.on('click', function () {
        GI.centerToMarker();
      });

      t.markerToCenter.on('click', function () {
        GI.markerToCenter();
      });

      t.storeZoomLevel.on('click', function () { Prefs.storeZoomLevel(GI.map.getZoom()); });
      t.storeMapCenter.on('click', function () { Prefs.storeMapCenter(GI.map.getCenter()); });
      // t.storeMarkerCount.on('click',function () { Prefs.storeMarkerCount() }); // todo
      t.clearPreferences.on('click', function () { Prefs.clearPreferences(); });

      // rev geocode result set actions
      t.revGeoCodeResultsHide.on('click', function () { t.rGeoResults.hide(); });

      t.togglePrefs.click(function () {
        var clicks = $GI.data('clicks');
        if (clicks) {
          t.prefsPanel.slideToggle();
        } else {
          t.prefsPanel.slideToggle();
        }
        $GI.data("clicks", !clicks);
      });
      
      return t;

    }();

    /**
     * MAP INITILIZATION
     */
    GI.initialize = function () {
      GI.mapOptions = {
        zoom : settings.zoomLevel,
        center : settings.mapCenter
      };

      GI.map = new google.maps.Map(document.getElementById('dmgig_map_' + $GIid), GI.mapOptions);

      GI.marker.setPosition(settings.mapCenter);
      GI.marker.setMap(GI.map);
      GI.marker.setDraggable(true);

      GI.setLatLngInputs();
    };

    /**
     * MARKER FUNCTIONS
     */

    /**
     * marker event listener - drag end */
    GI.watchMarkerMove = google.maps.event.addListener(GI.marker, 'dragend', function () {
      GI.setLatLngInputs();
      Layout.hiddenInputs.empty(); // clear out the rev geocode inputs, just in case they exist
    });

    /**
     * sets the hidden lat/lng inputs with the current marker position, and updates the lat/lng display as well. */
    GI.setLatLngInputs = function () {

      var latLng, s_latLng;

      latLng = GI.marker.getPosition();
      s_latLng = latLng.lat().toFixed(settings.precision) + ',' + latLng.lng().toFixed(settings.precision);
      Layout.latLngDisplay.html(s_latLng);
      Layout.latInput.val(latLng.lat().toFixed(settings.precision));
      Layout.lngInput.val(latLng.lng().toFixed(settings.precision));
    };

    /**
     * sets the map center to the current marker position */
    GI.centerToMarker = function () {
      GI.map.setCenter(GI.marker.getPosition());
      GI.setLatLngInputs();
    };

    /**
     * sets the marker position to the map center */
    GI.markerToCenter = function () {
      GI.marker.setPosition(GI.map.getCenter());
      GI.setLatLngInputs();
    };

    /**
     * GEOCODE FUNCTIONS
     */

    /**
     * attempts geocode a location based on user input in the geocode search field. 
     * If successful, the map is centered on the lat/lng 
     */
    GI.geocodeTextLocation = function () {

      var uriEncodedLocation, center_to, search_input;

      search_input = Layout.geoCodeInput.val();
      uriEncodedLocation = encodeURIComponent(Layout.geoCodeInput.val());
      $.get('https://maps.googleapis.com/maps/api/geocode/json?address=' + uriEncodedLocation, function (data) {
        center_to = new google.maps.LatLng(data.results[0].geometry.location.lat, data.results[0].geometry.location.lng);
        GI.map.setCenter(center_to);
        GI.markerToCenter();
      }).fail(function () { alert('Failed to geocode ' + search_input); });
    };

    /**
     * REVERSE GEOCODE FUNCTIONS
     */

    /**
     * reverse geocodes based on marker position, displays the results, if any, 
     * in a table below the input display 
     */
    GI.reverseGeocodeMarkerPosition = function () {

      var host, params = [], url, latLng, s_latLng, uriEncodedLatLng;

      latLng = GI.marker.getPosition();
      s_latLng = latLng.lat().toString() + ',' + latLng.lng().toString();
      uriEncodedLatLng = encodeURIComponent(s_latLng);

      host = 'https://maps.googleapis.com/maps/api/geocode/json';
      params.push('latlng=' + uriEncodedLatLng);
      params.push('location_type=ROOFTOP');
      params.push('result_type=street_address');
      params.push('key=' + settings.apikey);
      url = host + '?' + params.join('&');

      $.get(url, function (data) {
        var components, i;

        Layout.hiddenInputs.empty();
        Layout.revGeoCodeResultsBody.empty();
        Layout.revGeoCodeFoundCount.html(data.results.length);
        Layout.rGeoResults.show();
        if (data.results.length === 0) { return; }

        components = data.results[0].address_components;
        for (i in components) {
          $(GI.revGeocodeResultsMakeRow(components[i].long_name, components[i].types))
            .appendTo(Layout.revGeoCodeResultsBody);
          $(GI.revGeocodeResultsAddHiddenInputs(components[i].short_name, components[i].types));
        }

      }).fail(function () { alert('Failed to reverse geocode ' + s_latLng); });
    };

    /**
     *  creates table row for with long_name and type */
    GI.revGeocodeResultsMakeRow = function (long_name, types) {
      return $('<tr><td><b>' + long_name + '</b> <i>' + types.join(', ') + '</i></td><td>&square;</td></tr>');
    };

    /**
     * appends hidden input to parent div, uses first type element as name, value with short name */
    GI.revGeocodeResultsAddHiddenInputs = function (short_name, types) {
      $('<input/>', { type : "hidden", name : types[0], value : short_name }).appendTo(Layout.hiddenInputs);
    };

    /**
     * PARENT FORM CONTROL
     *
     * on submit, disable the extra inputs so they aren't serialized into the form data. 
     * because disabled elements in some browsers won't respond to jQuery, we just wait for the serialization to happen
     * and then re-enable the fields
     */
    GI.parent_form = $GI.closest('form');
    GI.parent_form.on('submit', function () {
      Layout.geoCodeInput.prop('disabled', true); // disable the search input so it doesn't appear in results
      setTimeout(function () { // re-enable the search_input field after serialize has executed
        Layout.geoCodeInput.prop('disabled', false);
      }, 300);
      return false;
    });

    /** INITIALIZE */

    if (!Helper.validateUniqueElementId($GI)) {
      console.log('geoInput Err: input elements require unique ids.');
      return false;
    }
    console.log(settings.apikey)
    GI.initialize();

  };

}(jQuery, google, dmgig_icons));
